<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tables</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  // === TAB SWITCHER ===
  function switchTab(tabId) {
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Hide all, show selected
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(tabId).classList.remove('hidden');

    // Button styling
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('border-blue-600','text-blue-600');
      btn.classList.add('border-transparent','text-gray-600');
    });
    const activeBtn = document.getElementById('btn-' + tabId);
    activeBtn.classList.add('border-blue-600','text-blue-600');
    activeBtn.classList.remove('border-transparent','text-gray-600');

    // Update URL hash
    window.location.hash = tabId;
  }

  // === ON PAGE LOAD: pick up active_tab GET or hash, default to insurance-tab ===
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    let active = params.get('active_tab') || window.location.hash.slice(1) || 'insurance-tab';
    switchTab(active);
  });

  // === PRESERVE TAB IN FILTER FORMS ===
  document.querySelectorAll('form[method="get"]').forEach(form => {
    // add hidden input if missing
    if (!form.querySelector('input[name="active_tab"]')) {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'active_tab';
      hidden.id   = 'active_tab_input';
      form.appendChild(hidden);
    }
    form.addEventListener('submit', () => {
      const current = document.querySelector('.tab-content:not(.hidden)').id;
      form.querySelector('input[name="active_tab"]').value = current;
    });
  });
</script>


</head>
<body class="bg-gray-100 p-6 text-gray-800">

  <h1 class="text-2xl font-bold mb-6 text-blue-700">Model Tables</h1>

  <!-- Tab Buttons -->
  <div class="flex border-b border-gray-300 mb-6 space-x-6">
    <button id="btn-insurance-tab" onclick="switchTab('insurance-tab')" class="tab-button pb-2 border-b-2 border-blue-600 text-blue-600 font-medium">
      Insurance Edits
    </button>
    <button id="btn-modifier-tab" onclick="switchTab('modifier-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
      Modifier Rules
    </button>
    <button id="btn-client-tab" onclick="switchTab('client-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
      Clients
    </button>
  </div>

  <!-- Insurance Tab -->
  <div id="insurance-tab" class="tab-content">
    <form method="get" class="mb-4">
  <div class="flex flex-wrap gap-4 text-sm items-center">
    <select name="payer_name" class="p-2 border rounded">
      <option value="">Payer Name</option>
      {% for name in payer_names %}
        <option value="{{ name }}" {% if request.GET.payer_name == name %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <select name="payer_category" class="p-2 border rounded">
      <option value="">Payer Category</option>
      {% for cat in payer_categories %}
        <option value="{{ cat }}" {% if request.GET.payer_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    <select name="edit_type" class="p-2 border rounded">
      <option value="">Edit Category</option>
      {% for et in edit_types %}
        <option value="{{ et }}" {% if et == filters.edit_type %}selected{% endif %}>{{ et }}</option>
      {% endfor %}
    </select>

    <select name="edit_sub_category" class="p-2 border rounded">
      <option value="">Sub Category</option>
      {% for sub in edit_sub_categories %}
        <option value="{{ sub }}" {% if request.GET.edit_sub_category == sub %}selected{% endif %}>{{ sub }}</option>
      {% endfor %}
    </select>

    <input type="hidden" name="active_tab" id="active_tab_input" value="">

    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
    <a href="{% url 'model_tables' %}#insurance-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>
  </div>
</form>


    <div class="overflow-x-auto bg-white p-4 rounded shadow">
  <!-- Header with Add button -->
  <h2 class="text-lg font-semibold mb-3 flex justify-between items-center">
    <span>Insurance Edit Records</span>
    <button onclick="openInsuranceModal()" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 text-sm">
      + Add Insurance
    </button>
  </h2>

  <table class="min-w-full table-fixed text-sm border border-gray-300">
    <thead class="bg-gray-200 text-left">
      <tr>
        <th class="p-2 border-r">Payer Name</th>
        <th class="p-2 border-r">Payer Category</th>
        <th class="p-2 border-r">Edits Category</th>
        <th class="p-2 border-r">Edits Sub-Category</th>
        <th class="p-2 whitespace-wrap">Instruction</th>
        <th class="p-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% regroup insurance_edits|slice:":50" by payer_name as payer_groups %}
      {% if payer_groups %}
        {% for group in payer_groups %}
          <!-- Group header row -->
          <tr class="bg-blue-50 border-t">
            <td colspan="6" class="p-2 font-semibold flex justify-between items-center">
              <span>{{ group.grouper }}</span>
              <button
                id="btn-{{ group.grouper|slugify }}"
                type="button"
                onclick="togglePayer('{{ group.grouper|slugify }}')"
                class="text-blue-600 text-sm hover:underline">
                See More
              </button>
            </td>
          </tr>

          <!-- Detail rows, hidden by default -->
          {% for edit in group.list %}
            <tr class="border-t hidden" data-payer="{{ group.grouper|slugify }}">
              <td class="p-2 border-r">{{ edit.payer_name }}</td>
              <td class="p-2 border-r">{{ edit.payer_category }}</td>
              <td class="p-2 border-r">{{ edit.edit_type }}</td>
              <td class="p-2 border-r">{{ edit.edit_sub_category }}</td>
              <td class="p-2 whitespace-pre-wrap break-words">{{ edit.instruction }}</td>
              <td class="p-2 border-l flex gap-2">
                <button onclick="openEditModal({{ edit.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button
                  onclick="openDeleteModal('{% url 'insurance_delete' edit.id %}', 'Delete “{{ edit.payer_name }}”?')"
                  class="text-red-600 hover:underline text-sm">
                  Delete
                </button>
              </td>
            </tr>
          {% endfor %}

        {% endfor %}
      {% else %}
        <tr>
          <td colspan="6" class="text-center text-gray-500 p-4">No records available.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Toggle script -->
<script>
  function togglePayer(slug) {
    const rows = document.querySelectorAll(`[data-payer="${slug}"]`);
    const btn = document.getElementById(`btn-${slug}`);
    if (!rows.length || !btn) return;

    const isCurrentlyHidden = rows[0].classList.contains('hidden');
    rows.forEach(r => r.classList.toggle('hidden'));
    btn.textContent = isCurrentlyHidden ? 'Hide' : 'See More';
  }
</script>

  </div>

  <!-- Insurance Edit Modal -->
<div id="insuranceModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
    <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Insurance</h2>
    <form id="insuranceForm">
      {% csrf_token %}
      <input type="hidden" id="insuranceId" name="id">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Payer Name</label>
          <input type="text" id="payerName" name="payer_name" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Payer Category</label>
          <input type="text" id="payerCategory" name="payer_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Edit Type</label>
          <input type="text" id="editType" name="edit_type" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Edit Sub-Category</label>
          <input type="text" id="editSubCategory" name="edit_sub_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium">Instruction</label>
          <textarea id="instruction" name="instruction" class="mt-1 p-2 border rounded w-full"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeInsuranceModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

  <!-- Delete Confirmation Modal -->
<div id="deleteInsuranceModal"
     class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <!-- Close Icon -->
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteInsuranceMessage" class="mb-6">Are you sure you want to delete this record?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
      <button id="confirmDeleteInsuranceBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

  <script>
function openInsuranceModal() {
  document.getElementById('insuranceForm').reset();
  document.getElementById('insuranceId').value = '';
  document.getElementById('modalTitle').innerText = 'Add Insurance';
  document.getElementById('insuranceModal').classList.remove('hidden');
}

function openEditModal(id) {
  fetch(`/insurance/edit/${id}/`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('insuranceId').value = data.id;
      document.getElementById('payerName').value = data.payer_name;
      document.getElementById('payerCategory').value = data.payer_category;
      document.getElementById('editType').value = data.edit_type;
      document.getElementById('editSubCategory').value = data.edit_sub_category;
      document.getElementById('instruction').value = data.instruction;
      document.getElementById('modalTitle').innerText = 'Edit Insurance';
      document.getElementById('insuranceModal').classList.remove('hidden');
    });
}

function closeInsuranceModal() {
  document.getElementById('insuranceModal').classList.add('hidden');
}

// Handle form submit
document.getElementById('insuranceForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('insuranceId').value;
  const url = id ? `/insurance/edit/${id}/` : `/insurance/create/`;
  const method = 'POST';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: new URLSearchParams({
      payer_name: document.getElementById('payerName').value,
      payer_category: document.getElementById('payerCategory').value,
      edit_type: document.getElementById('editType').value,
      edit_sub_category: document.getElementById('editSubCategory').value,
      instruction: document.getElementById('instruction').value
    })
  }).then(res => {
    if (res.ok) {
      location.reload();
    }
  });
});

  let deleteUrl = null;

  function openDeleteModal(url, message) {
    deleteUrl = url;
    document.getElementById('deleteInsuranceMessage').innerText = message || 'Are you sure you want to delete this record?';
    document.getElementById('deleteInsuranceModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = null;
    document.getElementById('deleteInsuranceModal').classList.add('hidden');
  }

  document.getElementById('confirmDeleteInsuranceBtn').addEventListener('click', function() {
    if (!deleteUrl) return;
    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then(res => {
      if (res.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });
</script>



  <!-- Modifier Tab -->
  <div id="modifier-tab" class="tab-content hidden">
    <form method="get" class="mb-4">
  <div class="flex flex-wrap items-center gap-4 text-sm">

    <!-- Payer Name -->
    <select name="payer_name" class="p-2 border rounded min-w-[12rem]">
      <option value="">Payer Name</option>
      {% for name in mod_payer_names %}
        <option value="{{ name }}" {% if filters.payer_name == name %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <!-- Payer Category -->
    <select name="payer_category" class="p-2 border rounded min-w-[12rem]">
      <option value="">Payer Category</option>
      {% for cat in mod_payer_categories %}
        <option value="{{ cat }}" {% if filters.payer_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    <!-- Code Type -->
    <select name="code_type" class="p-2 border rounded min-w-[12rem]">
      <option value="">Code Type</option>
      {% for ct in code_types %}
        <option value="{{ ct }}" {% if filters.code_type == ct %}selected{% endif %}>{{ ct }}</option>
      {% endfor %}
    </select>

    <!-- Code List Search -->
    <input type="text" name="code_list" placeholder="Search Code e.g. L0464 or E0870"
           value="{{ filters.code_list }}" class="p-2 border rounded min-w-[15rem]" />

    <!-- Sub Category Search -->
    <input type="text" name="sub_category" placeholder="Search Sub Category"
           value="{{ filters.sub_category }}" class="p-2 border rounded min-w-[14rem]" />

    <!-- Hidden tab memory -->
    <input type="hidden" name="active_tab" id="active_tab_input" value="modifier-tab">

    <!-- Buttons -->
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
    <a href="{% url 'model_tables' %}#modifier-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>

  </div>
</form>

    <!-- Modifier Tab -->

  <!-- Header with Add button -->
  <div class="overflow-x-auto bg-white p-4 rounded shadow mb-6">
    <h2 class="text-lg font-semibold mb-3 flex justify-between items-center">
      <span>Modifier Rule Records</span>
      <button onclick="openModifierModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
        + Add Modifier
      </button>
    </h2>

    <table class="min-w-full table-fixed text-sm border border-gray-300">
      <thead class="bg-gray-200 text-left">
        <tr>
          <th class="p-2 border-r">Payer Name</th>
          <th class="p-2 border-r">Payer Category</th>
         <th class="p-2 w-56 border-r">CPT Code Type</th>
    <th class="p-2 w-64 border-r">CPT Code Section</th>
          <th class="p-2 border-r">CPT Sub-Category</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% regroup modifier_rules|slice:":50" by payer_name as payer_groups %}
        {% if payer_groups %}
          {% for group in payer_groups %}
            <!-- Group header -->
            <tr class="bg-blue-50 border-t">
              <td colspan="6" class="p-2 font-semibold flex justify-between items-center">
                <span>{{ group.grouper }}</span>
                <button
                  id="mod-btn-{{ group.grouper|slugify }}"
                  type="button"
                  onclick="togglePayer('{{ group.grouper|slugify }}')"
                  class="text-blue-600 text-sm hover:underline">
                  See More
                </button>
              </td>
            </tr>
            <!-- Detail rows -->
            {% for rule in group.list %}
              <tr class="border-t hidden" data-payer="{{ group.grouper|slugify }}">
                <td class="p-2 border-r">{{ rule.payer_name }}</td>
                <td class="p-2 border-r">{{ rule.payer_category }}</td>
                <td class="p-2 border-r">{{ rule.code_type }}</td>
                <td class="p-2 border-r whitespace-pre-wrap break-words">{{ rule.code_list }}</td>
                <td class="p-2 border-r">{{ rule.sub_category }}</td>
                <td class="p-2 flex gap-2">
                  <button onclick="openModifierEditModal({{ rule.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                  <button
                    onclick="openDeleteModal('{% url 'modifier_delete' rule.id %}', 'Delete “{{ rule.payer_name }} – {{ rule.code_list }}”?')"
                    class="text-red-600 hover:underline text-sm">
                    Delete
                  </button>
                </td>
              </tr>
            {% endfor %}
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-gray-500 p-4">No records available.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit Modal for Modifier -->
<div id="modifierModal"
     class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
    <h3 id="modModalTitle" class="text-xl font-semibold mb-4">Add Modifier</h3>
    <form id="modifierForm">
      {% csrf_token %}
      <input type="hidden" id="modifierId" name="id">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Payer Name</label>
          <input type="text" id="modPayerName" name="payer_name" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Payer Category</label>
          <input type="text" id="modPayerCategory" name="payer_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">CPT Code Type</label>
          <input type="text" id="modCodeType" name="code_type" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">CPT Code Section</label>
          <input type="text" id="modCodeList" name="code_list" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Sub-Category</label>
          <input type="text" id="modSubCategory" name="sub_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium">Modifier Instruction</label>
          <textarea id="modInstruction" name="modifier_instruction" class="mt-1 p-2 border rounded w-full"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeModifierModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Shared Delete Confirmation Modal (if not already present) -->
<div id="deleteModifierModal"
     class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteModifierMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmModifierDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ✅ Toggle Group Function
  function togglePayer(slug) {
    const rows = document.querySelectorAll(`[data-payer="${slug}"]`);
    const btn = document.getElementById(`mod-btn-${slug}`) || document.getElementById(`btn-${slug}`);
    if (!rows.length || !btn) return;
    const hide = rows[0].classList.contains('hidden');
    rows.forEach(r => r.classList.toggle('hidden'));
    btn.textContent = hide ? 'Hide' : 'See More';
  }

  window.togglePayer = togglePayer; // Make accessible from inline onclick

  // ✅ Create/Edit Modal
  function openModifierModal() {
    console.log("Modifier modal opening..."); // ✅ DEBUG
    document.getElementById('modifierForm').reset();
    document.getElementById('modifierId').value = '';
    document.getElementById('modModalTitle').innerText = 'Add Modifier';
    document.getElementById('modifierModal').classList.remove('hidden');
  }

  function closeModifierModal() {
    document.getElementById('modifierModal').classList.add('hidden');
  }

  function openModifierEditModal(id) {
    fetch(`/modifier/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('modifierId').value = data.id;
        document.getElementById('modPayerName').value = data.payer_name;
        document.getElementById('modPayerCategory').value = data.payer_category;
        document.getElementById('modCodeType').value = data.code_type;
        document.getElementById('modCodeList').value = data.code_list;
        document.getElementById('modSubCategory').value = data.sub_category;
        document.getElementById('modInstruction').value = data.modifier_instruction;
        document.getElementById('modModalTitle').innerText = 'Edit Modifier';
        document.getElementById('modifierModal').classList.remove('hidden');
      });
  }

  window.openModifierModal = openModifierModal;
  window.openModifierEditModal = openModifierEditModal;
  window.closeModifierModal = closeModifierModal;

  // ✅ Form Submit
  document.getElementById('modifierForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('modifierId').value;
    const url = id ? `/modifier/edit/${id}/` : `/modifier/create/`;
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        payer_name: document.getElementById('modPayerName').value,
        payer_category: document.getElementById('modPayerCategory').value,
        code_type: document.getElementById('modCodeType').value,
        code_list: document.getElementById('modCodeList').value,
        sub_category: document.getElementById('modSubCategory').value,
        modifier_instruction: document.getElementById('modInstruction').value
      })
    }).then(r => r.json()).then(data => {
      if (data.success) {
        closeModifierModal();
        location.reload();
      } else {
        alert('Save failed');
      }
    });
  });

  // ✅ Delete
  let deleteUrl = '';
  function openDeleteModal(url, msg) {
    deleteUrl = url;
    document.getElementById('deleteModifierMessage').innerText = msg;
    document.getElementById('deleteModifierModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = '';
    document.getElementById('deleteModifierModal').classList.add('hidden');
  }

  window.openDeleteModal = openDeleteModal;
  window.closeDeleteModal = closeDeleteModal;

  document.getElementById('confirmModifierDeleteBtn').addEventListener('click', function () {
    if (!deleteUrl) return;
    fetch(deleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => {
      if (r.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });
});
</script>




  <!-- Clients Tab -->
<div id="client-tab" class="tab-content hidden">
  <!-- 1) Filter Form -->
  <form method="get" class="mb-4">
    <div class="flex flex-wrap items-center gap-4 text-sm">
      <input type="text" name="client_name" placeholder="Search Client Name"
             value="{{ filters.client_name }}" class="p-2 border rounded min-w-[16rem]" />
      <select name="active" class="p-2 border rounded">
        <option value="">All Status</option>
        <option value="true" {% if filters.active == 'true' %}selected{% endif %}>Active</option>
        <option value="false" {% if filters.active == 'false' %}selected{% endif %}>Inactive</option>
      </select>
      <input type="hidden" name="active_tab" value="client-tab" />
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
      <a href="{% url 'model_tables' %}?active_tab=client-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>
    </div>
  </form>

  <!-- 2) Table & Add Button -->
  <div class="overflow-x-auto bg-white p-4 rounded shadow mb-6">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">Client List</h2>
      <button onclick="openClientModal()" class="bg-indigo-600 text-white px-4 py-1 rounded hover:bg-indigo-700 text-sm">
        + Add Client
      </button>
    </div>
    <table class="min-w-full table-auto text-sm border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 text-left">Name</th>
          <th class="p-2 text-center">Active</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if clients %}
          {% for client in clients %}
            <tr class="border-t">
              <td class="p-2">{{ client.name }}</td>
              <td class="p-2 text-center">{{ client.active|yesno:"✅,❌" }}</td>
              <td class="p-2 flex gap-2">
                <button onclick="openClientEditModal({{ client.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button onclick="openDeleteModal('{% url 'client_delete' client.id %}', 'Delete client “{{ client.name }}”?')"
                        class="text-red-600 hover:underline text-sm">Delete</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="3" class="text-center text-gray-500 p-4">No clients found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- 3) Create/Edit Client Modal -->
<div id="clientModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 id="clientModalTitle" class="text-lg font-semibold mb-4">Add Client</h3>
    <form id="clientForm">
      {% csrf_token %}
      <input type="hidden" id="clientId">
      <input type="text" id="clientName" name="name" class="w-full border p-2 mb-3" placeholder="Client Name" />
      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="clientActive" class="h-4 w-4" />
        <label for="clientActive">Active</label>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeClientModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>


<!-- 4) Shared Delete Confirmation Modal -->
<div id="deleteModal"
     class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- 5) JavaScript Handlers -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ✅ Create Modal
  function openClientModal() {
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    document.getElementById('clientActive').checked = false;
    document.getElementById('clientModalTitle').innerText = 'Add Client';
    document.getElementById('clientModal').classList.remove('hidden');
  }

  function closeClientModal() {
    document.getElementById('clientModal').classList.add('hidden');
  }

  function openClientEditModal(id) {
    fetch(`/client/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('clientId').value = data.id;
        document.getElementById('clientName').value = data.name;
        document.getElementById('clientActive').checked = data.active;
        document.getElementById('clientModalTitle').innerText = 'Edit Client';
        document.getElementById('clientModal').classList.remove('hidden');
      });
  }

  // Expose functions to global scope for inline onclick=""
  window.openClientModal = openClientModal;
  window.openClientEditModal = openClientEditModal;
  window.closeClientModal = closeClientModal;

  // ✅ Submit Form Handler
  document.getElementById('clientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('clientId').value;
    const url = id ? `/client/edit/${id}/` : `/client/create/`;
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        name: document.getElementById('clientName').value,
        active: document.getElementById('clientActive').checked ? 'true' : 'false'
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        closeClientModal();
        location.reload();
      } else {
        alert('Save failed');
      }
    });
  });

  // ✅ Delete Modal
  let deleteUrl = '';
  function openDeleteModal(url, msg) {
    deleteUrl = url;
    document.getElementById('deleteMessage').innerText = msg;
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = '';
    document.getElementById('deleteModal').classList.add('hidden');
  }

  window.openDeleteModal = openDeleteModal;
  window.closeDeleteModal = closeDeleteModal;

  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    fetch(deleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => {
      if (r.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });
});
</script>

</body>
</html>

