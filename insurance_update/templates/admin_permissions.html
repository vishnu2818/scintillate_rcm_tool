{% extends "base.html" %}

{% block title %}Role-Based Access | Scintillate RCM{% endblock %}
{% block header_title %}Role-Based Access Control{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-blue-100 space-y-8 transition-all">

  {% if messages %}
    {% for message in messages %}
      <div class="px-4 py-3 rounded-lg shadow-sm text-sm
                  {% if message.tags == 'success' %}
                    bg-green-100 border border-green-300 text-green-800
                  {% else %}
                    bg-red-100 border border-red-300 text-red-800
                  {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <!-- User Dropdown -->
    <div class="space-y-1">
      <label for="userSelect" class="block text-sm font-medium text-gray-700">ðŸ‘¤ Select a User</label>
      <select id="userSelect" name="selected_user"
              class="w-64 px-4 py-2 rounded-md border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none text-sm">
        <option value="">-- Choose a User --</option>
        {% for user in users %}
          <option value="{{ user.id }}">{{ user.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Permission Table -->
    <div id="permissionsTable" class="hidden mt-10 transition-all">
      <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-blue-50">
            <tr>
              <th class="px-6 py-3 text-left text-blue-700 font-semibold border-b border-gray-300">Model - Action</th>
              <th class="px-6 py-3 text-center border-b border-gray-300">
                <div class="flex flex-col items-center">
                  <input type="checkbox" id="selectAll" class="accent-blue-600 h-4 w-4">
                  <label for="selectAll" class="text-xs text-gray-600 mt-1">Select All</label>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for model in models %}
              {% for action in actions %}
                <tr class="hover:bg-gray-50 transition border-t border-gray-100">
                  <td class="px-6 py-3 font-medium text-gray-800">
                    {{ model.name }} <span class="text-gray-400">â€“ {{ action|title }}</span>
                  </td>
                  <td class="px-6 py-3 text-center">
                    <input type="checkbox"
                           name="{{ model.key }}_selected_user_placeholder_{{ action }}"
                           data-original-name="{{ model.key }}_selected_user_placeholder_{{ action }}"
                           class="permission-checkbox accent-blue-600 h-4 w-4">
                  </td>
                </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Submit -->
      <div class="mt-8 flex justify-end">
        <button type="submit"
                class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md shadow transition">
          Save Permissions
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  const userSelect = document.getElementById('userSelect');
  const permissionTable = document.getElementById('permissionsTable');
  const selectAllCheckbox = document.getElementById('selectAll');

  userSelect.addEventListener('change', function () {
    const userId = this.value;
    const checkboxes = permissionTable.querySelectorAll('input[type="checkbox"]:not(#selectAll)');

    if (userId) {
      permissionTable.classList.remove('hidden');

      checkboxes.forEach(cb => {
        let original = cb.getAttribute('data-original-name');
        if (!original) {
          original = cb.getAttribute('name');
          cb.setAttribute('data-original-name', original);
        }
        const newName = original.replace('selected_user_placeholder', userId);
        cb.setAttribute('name', newName);
      });
    } else {
      permissionTable.classList.add('hidden');
    }
  });

  selectAllCheckbox.addEventListener('change', function () {
    const allCheckboxes = document.querySelectorAll('.permission-checkbox');
    allCheckboxes.forEach(cb => {
      cb.checked = selectAllCheckbox.checked;
    });
  });
</script>
{% endblock %}
