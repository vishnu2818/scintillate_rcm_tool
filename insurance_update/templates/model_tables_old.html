{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tables</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById(tabId).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('border-blue-600', 'text-blue-600');
      btn.classList.add('border-transparent', 'text-gray-600');
    });

    const activeBtn = document.getElementById('btn-' + tabId);
    if (activeBtn) {
      activeBtn.classList.add('border-blue-600', 'text-blue-600');
      activeBtn.classList.remove('border-transparent', 'text-gray-600');
    }

    // Save active tab
    localStorage.setItem('activeTab', tabId);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const tabFromURL = urlParams.get('active_tab');
    const savedTab = localStorage.getItem('activeTab');

    const tabToShow = tabFromURL || savedTab || 'insurance-tab';
    switchTab(tabToShow);

    // Save active_tab back to localStorage if it comes from URL
    if (tabFromURL) {
      localStorage.setItem('activeTab', tabFromURL);
    }

    // Ensure hidden field exists in all filter forms
    document.querySelectorAll('form[method="get"]').forEach(form => {
      if (!form.querySelector('input[name="active_tab"]')) {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'active_tab';
        hidden.value = tabToShow;
        form.appendChild(hidden);
      }

      form.addEventListener('submit', () => {
        const current = document.querySelector('.tab-content:not(.hidden)').id;
        form.querySelector('input[name="active_tab"]').value = current;
      });
    });
  });
</script>



</head>
<body class="bg-gray-100 p-6 text-gray-800">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-blue-700">Model Tables</h1>
    <a href="{% url 'dashboard' %}" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm">
      Back to Dashboard
    </a>
  </div>

  <!-- Tab Buttons -->
  <div class="flex border-b border-gray-300 mb-6 space-x-6">
    <button id="btn-insurance-tab" onclick="switchTab('insurance-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
  Insurance Edits
</button>
<button id="btn-modifier-tab" onclick="switchTab('modifier-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
  Modifier Rules
</button>
<button id="btn-client-tab" onclick="switchTab('client-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
  Clients
</button>
    <button id="btn-scenario-tab" onclick="switchTab('scenario-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
    Scenario
  </button>
  <button id="btn-dxcategory-tab" onclick="switchTab('dxcategory-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
    Dx Category
  </button>
    <button id="btn-user-tab" onclick="switchTab('user-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
  User Account
</button>
    <button id="btn-activity-tab" onclick="switchTab('activity-tab')" class="tab-button pb-2 border-b-2 border-transparent text-gray-600 hover:text-blue-600 hover:border-blue-600">
  Activity Log
</button>

  </div>

  <!-- Insurance Tab -->
  <div id="insurance-tab" class="tab-content">
    <form method="get" class="mb-4">
  <div class="flex flex-wrap gap-4 text-sm items-center">
    <select name="payer_name" class="p-2 border rounded">
      <option value="">Payer Name</option>
      {% for name in payer_names %}
        <option value="{{ name }}" {% if request.GET.payer_name == name %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <select name="payer_category" class="p-2 border rounded">
      <option value="">Payer Category</option>
      {% for cat in payer_categories %}
        <option value="{{ cat }}" {% if request.GET.payer_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    <select name="edit_type" class="p-2 border rounded">
      <option value="">Edit Category</option>
      {% for et in edit_types %}
        <option value="{{ et }}" {% if et == filters.edit_type %}selected{% endif %}>{{ et }}</option>
      {% endfor %}
    </select>

    <select name="edit_sub_category" class="p-2 border rounded">
      <option value="">Sub Category</option>
      {% for sub in edit_sub_categories %}
        <option value="{{ sub }}" {% if request.GET.edit_sub_category == sub %}selected{% endif %}>{{ sub }}</option>
      {% endfor %}
    </select>

    <input type="hidden" name="active_tab" id="active_tab_input" value="">

    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
    <a href="{% url 'model_tables' %}#insurance-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>
  </div>
</form>

    <div class="overflow-x-auto bg-white p-4 rounded shadow">
  <!-- Header with Add button -->
  <h2 class="text-lg font-semibold mb-3 flex justify-between items-center">
    <span>Insurance Edit Records</span>
    <div class="flex gap-2 items-center">

  <!-- Upload Excel Form -->
  <form method="post" action="{% url 'insurance_preview_upload' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <label class="cursor-pointer bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
      Upload Excel
      <input type="file" name="excel_file" accept=".xlsx,.xls" onchange="this.form.submit()" hidden>
    </label>
  </form>

  <!-- Add Insurance Button -->
  <button onclick="openInsuranceModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
    Add Insurance
  </button>

        <a href="{% url 'insurance_download_excel' %}" >
        <button id="" type="button" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm">Download
        </button>
        </a>

</div>


  </h2>
<div class="overflow-y-auto max-h-[600px] border border-gray-300 rounded-md">
  <table class="min-w-full table-fixed text-sm">
    <thead class="bg-gray-200 text-left sticky top-0 z-10">
      <tr>
        <th class="p-2 border-r bg-gray-200">Payer Name</th>
        <th class="p-2 border-r bg-gray-200">Payer Category</th>
        <th class="p-2 border-r bg-gray-200">Edits Category</th>
        <th class="p-2 border-r bg-gray-200">Edits Sub-Category</th>
        <th class="p-2 whitespace-wrap bg-gray-200">Instruction</th>
        <th class="p-2 bg-gray-200">Actions</th>
      </tr>
    </thead>
    <tbody>
  {% if grouped_insurance_edits %}
    {% for group, edits in grouped_insurance_edits %}
      {% with payer_name=group.0 payer_category=group.1 %}
        {% with key=payer_name|slugify|add:"__"|add:payer_category|slugify %}
          <!-- Group Header Row -->
          <tr class="bg-blue-50 border-t text-sm">
            <td class="p-1 w-[200px] font-semibold truncate">
              {{ payer_name }} — {{ payer_category }}
            </td>
            <td class="p-1 w-[200px]">
              <button
                id="btn-{{ key }}"
                type="button"
                onclick="togglePayer('{{ key }}')"
                class="text-blue-600 text-xs px-2 py-0.5 border border-blue-300 rounded hover:bg-blue-100">
                See More
              </button>
            </td>
            <td colspan="4" class="p-1"></td>
          </tr>

          {% for edit in edits %}
            <tr class="border-t hidden" data-payer="{{ key }}">
              <td class="p-2 border-r">{{ edit.payer_name }}</td>
              <td class="p-2 border-r">{{ edit.payer_category }}</td>
              <td class="p-2 border-r">{{ edit.edit_type }}</td>
              <td class="p-2 border-r">{{ edit.edit_sub_category }}</td>
              <td class="p-2 w-[400px] whitespace-pre-wrap break-words">{{ edit.instruction }}</td>
              <td class="p-2 border-l flex gap-2">
                <button onclick="openEditModal({{ edit.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button
                  onclick="openDeleteModal('{% url 'insurance_delete' edit.id %}', 'Delete “{{ edit.payer_name }}”?')"
                  class="text-red-600 hover:underline text-sm">
                  Delete
                </button>
              </td>
            </tr>
          {% endfor %}
        {% endwith %}
      {% endwith %}
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="6" class="text-center text-gray-500 py-6">No records found.</td>
    </tr>
  {% endif %}
</tbody>

  </table>
</div>

</div>


<!-- Toggle script -->
<script>
  function togglePayer(slug) {
    const rows = document.querySelectorAll(`[data-payer="${slug}"]`);
    const btn = document.getElementById(`btn-${slug}`);
    if (!rows.length || !btn) return;

    const isCurrentlyHidden = rows[0].classList.contains('hidden');
    rows.forEach(r => r.classList.toggle('hidden'));
    btn.textContent = isCurrentlyHidden ? 'Hide' : 'See More';
  }
</script>

  </div>

  <!-- Insurance Edit Modal -->
<div id="insuranceModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
    <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Insurance</h2>
    <form id="insuranceForm">
      {% csrf_token %}
      <input type="hidden" id="insuranceId" name="id">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Payer Name</label>
          <input type="text" id="payerName" name="payer_name" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Payer Category</label>
          <input type="text" id="payerCategory" name="payer_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Edit Type</label>
          <input type="text" id="editType" name="edit_type" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Edit Sub-Category</label>
          <input type="text" id="editSubCategory" name="edit_sub_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium">Instruction</label>
          <textarea id="instruction" name="instruction" class="mt-1 p-2 border rounded w-full"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeInsuranceModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

  <!-- Delete Confirmation Modal -->
<div id="deleteInsuranceModal"
     class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <!-- Close Icon -->
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteInsuranceMessage" class="mb-6">Are you sure you want to delete this record?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
      <button id="confirmDeleteInsuranceBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

  <script>
function openInsuranceModal() {
  document.getElementById('insuranceForm').reset();
  document.getElementById('insuranceId').value = '';
  document.getElementById('modalTitle').innerText = 'Add Insurance';
  document.getElementById('insuranceModal').classList.remove('hidden');
}

function openEditModal(id) {
  fetch(`/insurance/edit/${id}/`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('insuranceId').value = data.id;
      document.getElementById('payerName').value = data.payer_name;
      document.getElementById('payerCategory').value = data.payer_category;
      document.getElementById('editType').value = data.edit_type;
      document.getElementById('editSubCategory').value = data.edit_sub_category;
      document.getElementById('instruction').value = data.instruction;
      document.getElementById('modalTitle').innerText = 'Edit Insurance';
      document.getElementById('insuranceModal').classList.remove('hidden');
    });
}

function closeInsuranceModal() {
  document.getElementById('insuranceModal').classList.add('hidden');
}

// Handle form submit
document.getElementById('insuranceForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('insuranceId').value;
  const url = id ? `/insurance/edit/${id}/` : `/insurance/create/`;
  const method = 'POST';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: new URLSearchParams({
      payer_name: document.getElementById('payerName').value,
      payer_category: document.getElementById('payerCategory').value,
      edit_type: document.getElementById('editType').value,
      edit_sub_category: document.getElementById('editSubCategory').value,
      instruction: document.getElementById('instruction').value
    })
  }).then(res => {
    if (res.ok) {
      location.reload();
    }
  });
});

  let deleteUrl = null;

  function openDeleteModal(url, message) {
    deleteUrl = url;
    document.getElementById('deleteInsuranceMessage').innerText = message || 'Are you sure you want to delete this record?';
    document.getElementById('deleteInsuranceModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = null;
    document.getElementById('deleteInsuranceModal').classList.add('hidden');
  }

  document.getElementById('confirmDeleteInsuranceBtn').addEventListener('click', function() {
    if (!deleteUrl) return;
    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then(res => {
      if (res.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });
</script>



  <!-- Modifier Tab -->
  <div id="modifier-tab" class="tab-content hidden">
    <form method="get" class="mb-4">
  <div class="flex flex-wrap items-center gap-4 text-sm">

    <!-- Payer Name -->
    <select name="payer_name" class="p-2 border rounded min-w-[12rem]">
      <option value="">Payer Name</option>
      {% for name in mod_payer_names %}
        <option value="{{ name }}" {% if filters.payer_name == name %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <!-- Payer Category -->
    <select name="payer_category" class="p-2 border rounded min-w-[12rem]">
      <option value="">Payer Category</option>
      {% for cat in mod_payer_categories %}
        <option value="{{ cat }}" {% if filters.payer_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    <!-- Code Type -->
    <select name="code_type" class="p-2 border rounded min-w-[12rem]">
      <option value="">Code Type</option>
      {% for ct in code_types %}
        <option value="{{ ct }}" {% if filters.code_type == ct %}selected{% endif %}>{{ ct }}</option>
      {% endfor %}
    </select>

    <!-- Code List Search -->
    <input type="text" name="code_list" placeholder="Search Code e.g. L0464 or E0870"
           value="{{ filters.code_list }}" class="p-2 border rounded min-w-[15rem]" />

    <!-- Sub Category Search -->
    <input type="text" name="sub_category" placeholder="Search Sub Category"
           value="{{ filters.sub_category }}" class="p-2 border rounded min-w-[14rem]" />

    <!-- Hidden tab memory -->
    <input type="hidden" name="active_tab" id="active_tab_input" value="modifier-tab">

    <!-- Buttons -->
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
    <a href="{% url 'model_tables' %}#modifier-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>

  </div>
</form>

    <!-- Modifier Tab -->

    <div class="overflow-x-auto bg-white p-4 rounded shadow">
  <!-- Header with Title and Buttons -->
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-lg font-semibold">Modifier Records</h2>
    <div class="flex gap-2 items-center">
      <!-- Upload Excel Form -->
      <form method="post" action="{% url 'modifier_preview_upload' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <label class="cursor-pointer bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
          Upload Excel
          <input type="file" name="excel_file" accept=".xlsx,.xls" onchange="this.form.submit()" hidden>
        </label>
      </form>

      <!-- Add Modifier Button -->
      <button onclick="openModifierModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
        Add Modifier
      </button>

      <!-- Download Excel Button -->
      <a href="{% url 'download_modifier_excel' %}" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm">
        Download Excel
      </a>
    </div>
  </div>

<!--    <div class="overflow-x-auto bg-white p-4 rounded shadow">-->
<!--  &lt;!&ndash; Header with Add button &ndash;&gt;-->
<!--  <h2 class="text-lg font-semibold mb-3 flex justify-between items-center">-->
<!--    <span>Modifier Records</span></h2>-->
<!--    <div class="flex gap-2 items-center">-->

<!--    &lt;!&ndash; Upload Excel Form &ndash;&gt;-->
<!--    <form method="post" action="{% url 'modifier_preview_upload' %}" enctype="multipart/form-data">-->
<!--      {% csrf_token %}-->
<!--      <label class="cursor-pointer bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">-->
<!--        Upload Excel-->
<!--        <input type="file" name="excel_file" accept=".xlsx,.xls" onchange="this.form.submit()" hidden>-->
<!--      </label>-->
<!--    </form>-->

<!--    &lt;!&ndash; Add Insurance Button &ndash;&gt;-->
<!--    <button onclick="openModifierModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">-->
<!--      Add Modifier-->
<!--    </button>-->

<!--        <a href="{% url 'download_modifier_excel' %}" >-->
<!--        <button id="downloadDropdownBtn" type="button" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm">Download-->
<!--        </button>-->
<!--        </a>-->

<!--</div>-->


    <div class="overflow-y-auto max-h-[600px] border border-gray-300 rounded-md">
    <table class="min-w-full table-fixed text-sm">
      <thead class="bg-gray-200 text-left sticky top-0 z-10">
        <tr>
          <th class="p-2 border-r bg-gray-200">Payer Name</th>
          <th class="p-2 border-r bg-gray-200">Payer Category</th>
          <th class="p-2 w-56 border-r bg-gray-200">CPT Code Type</th>
          <th class="p-2 w-64 border-r bg-gray-200">CPT Code Section</th>
          <th class="p-2 border-r bg-gray-200">CPT Sub-Category</th>
          <th class="p-2 border-r bg-gray-200">Instructions</th>
          <th class="p-2 bg-gray-200">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if modifier_rules %}
          {% regroup modifier_rules by payer_name as payer_groups %}
          {% for payer_group in payer_groups %}
            {% regroup payer_group.list by payer_category as category_groups %}
            {% for category_group in category_groups %}
              {% with key=payer_group.grouper|stringformat:"s"|add:"__"|add:category_group.grouper %}
                <!-- Group Header Row -->
                <tr class="bg-blue-50 border-t text-sm">
                  <td class="p-1 w-[200px] font-semibold truncate">
                    {{ payer_group.grouper }} — {{ category_group.grouper }}
                  </td>
                  <td class="p-1 w-[200px]">
                    <button
                      id="mod-btn-{{ key|slugify }}"
                      type="button"
                      onclick="togglePayer('{{ key|slugify }}')"
                      class="text-blue-600 text-xs px-2 py-0.5 border border-blue-300 rounded hover:bg-blue-100">
                      See More
                    </button>
                  </td>
                  <td colspan="5" class="p-1"></td>
                </tr>

                {% for rule in category_group.list %}
                  <!-- Hidden Detail Row -->
                  <tr class="border-t hidden" data-payer="{{ key|slugify }}">
                    <td class="p-2 border-r">{{ rule.payer_name }}</td>
                    <td class="p-2 border-r">{{ rule.payer_category }}</td>
                    <td class="p-2 border-r">{{ rule.code_type }}</td>
                    <td class="p-2 border-r whitespace-pre-wrap break-words">{{ rule.code_list }}</td>
                    <td class="p-2 border-r">{{ rule.sub_category }}</td>
                    <td class="p-2 border-r">{{ rule.modifier_instruction }}</td>
                    <td class="p-2 flex gap-2">
                      <button onclick="openModifierEditModal({{ rule.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                      <button
                        onclick="openDeleteModal('{% url 'modifier_delete' rule.id %}', 'Delete “{{ rule.payer_name }} – {{ rule.code_list }}”?')"
                        class="text-red-600 hover:underline text-sm">
                        Delete
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              {% endwith %}
            {% endfor %}
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-gray-500 py-6">No records found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  </div>
</div>

<!-- Create/Edit Modal for Modifier -->
<div id="modifierModal"
     class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
    <h3 id="modModalTitle" class="text-xl font-semibold mb-4">Add Modifier</h3>
    <form id="modifierForm">
      {% csrf_token %}
      <input type="hidden" id="modifierId" name="id">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Payer Name</label>
          <input type="text" id="modPayerName" name="payer_name" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Payer Category</label>
          <input type="text" id="modPayerCategory" name="payer_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">CPT Code Type</label>
          <input type="text" id="modCodeType" name="code_type" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">CPT Code Section</label>
          <input type="text" id="modCodeList" name="code_list" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Sub-Category</label>
          <input type="text" id="modSubCategory" name="sub_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium">Modifier Instruction</label>
          <textarea id="modInstruction" name="modifier_instruction" class="mt-1 p-2 border rounded w-full"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeModifierModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Shared Delete Confirmation Modal (if not already present) -->
<div id="deleteModifierModal"
     class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteModifierMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmModifierDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ✅ Toggle Group Function
  function togglePayer(slug) {
    const rows = document.querySelectorAll(`[data-payer="${slug}"]`);
    const btn = document.getElementById(`mod-btn-${slug}`) || document.getElementById(`btn-${slug}`);
    if (!rows.length || !btn) return;
    const hide = rows[0].classList.contains('hidden');
    rows.forEach(r => r.classList.toggle('hidden'));
    btn.textContent = hide ? 'Hide' : 'See More';
  }

  window.togglePayer = togglePayer; // Make accessible from inline onclick

  // ✅ Create/Edit Modal
  function openModifierModal() {
    console.log("Modifier modal opening..."); // ✅ DEBUG
    document.getElementById('modifierForm').reset();
    document.getElementById('modifierId').value = '';
    document.getElementById('modModalTitle').innerText = 'Add Modifier';
    document.getElementById('modifierModal').classList.remove('hidden');
  }

  function closeModifierModal() {
    document.getElementById('modifierModal').classList.add('hidden');
  }

  function openModifierEditModal(id) {
    fetch(`/modifier/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('modifierId').value = data.id;
        document.getElementById('modPayerName').value = data.payer_name;
        document.getElementById('modPayerCategory').value = data.payer_category;
        document.getElementById('modCodeType').value = data.code_type;
        document.getElementById('modCodeList').value = data.code_list;
        document.getElementById('modSubCategory').value = data.sub_category;
        document.getElementById('modInstruction').value = data.modifier_instruction;
        document.getElementById('modModalTitle').innerText = 'Edit Modifier';
        document.getElementById('modifierModal').classList.remove('hidden');
      });
  }

  window.openModifierModal = openModifierModal;
  window.openModifierEditModal = openModifierEditModal;
  window.closeModifierModal = closeModifierModal;

  // ✅ Form Submit
  document.getElementById('modifierForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('modifierId').value;
    const url = id ? `/modifier/edit/${id}/` : `/modifier/create/`;
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        payer_name: document.getElementById('modPayerName').value,
        payer_category: document.getElementById('modPayerCategory').value,
        code_type: document.getElementById('modCodeType').value,
        code_list: document.getElementById('modCodeList').value,
        sub_category: document.getElementById('modSubCategory').value,
        modifier_instruction: document.getElementById('modInstruction').value
      })
    }).then(r => r.json()).then(data => {
      if (data.success) {
        closeModifierModal();
        location.reload();
      } else {
        alert('Save failed');
      }
    });
  });

  // ✅ Delete
  let deleteUrl = '';
  function openDeleteModal(url, msg) {
    deleteUrl = url;
    document.getElementById('deleteModifierMessage').innerText = msg;
    document.getElementById('deleteModifierModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = '';
    document.getElementById('deleteModifierModal').classList.add('hidden');
  }

  window.openDeleteModal = openDeleteModal;
  window.closeDeleteModal = closeDeleteModal;

  document.getElementById('confirmModifierDeleteBtn').addEventListener('click', function () {
    if (!deleteUrl) return;
    fetch(deleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => {
      if (r.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });
});
</script>



<!-- Clients Tab -->
<div id="client-tab" class="tab-content hidden">
  <!-- 1) Filter Form -->
  <form method="get" class="mb-4">
    <div class="flex flex-wrap items-center gap-4 text-sm">
      <input type="text" name="client_name" placeholder="Search Client Name"
             value="{{ filters.client_name }}" class="p-2 border rounded min-w-[16rem]" />
      <select name="active" class="p-2 border rounded">
        <option value="">All Status</option>
        <option value="true" {% if filters.active == 'true' %}selected{% endif %}>Active</option>
        <option value="false" {% if filters.active == 'false' %}selected{% endif %}>Inactive</option>
      </select>
      <input type="hidden" name="active_tab" value="client-tab" />
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
      <a href="{% url 'model_tables' %}?active_tab=client-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>
    </div>
  </form>


<!--    <h2 class="text-lg font-semibold mb-3 flex justify-between items-center">-->

<!--    <div class="flex gap-2 items-center">-->

  <!-- 2) Table & Add Button -->
  <div class="overflow-x-auto bg-white p-4 rounded shadow mb-6">
    <span>Modifier Records</span>
    <div class="flex gap-3 items-center mb-3">

      <!-- Upload Excel Button -->
  <form method="post" action="{% url 'insurance_preview_upload' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <label class="cursor-pointer bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 text-sm">
      Upload Excel
      <input type="file" name="excel_file" accept=".xlsx,.xls" onchange="this.form.submit()" hidden>
    </label>
  </form>

  <!-- Add Client/Insurance Button -->
  <button onclick="openClientModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
    Add Client
  </button>

</div>

    <table class="min-w-full table-auto text-sm border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 text-left">Name</th>
          <th class="p-2 text-center">Active</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if clients %}
          {% for client in clients %}
            <tr class="border-t">
              <td class="p-2">{{ client.name }}</td>
              <td class="p-2 text-center">{{ client.active|yesno:"✅,❌" }}</td>
              <td class="p-2 flex gap-2">
                <button onclick="openClientEditModal({{ client.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button onclick="openDeleteModal('{% url 'client_delete' client.id %}', 'Delete client “{{ client.name }}”?')"
                        class="text-red-600 hover:underline text-sm">Delete</button>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="3" class="text-center text-gray-500 p-4">No clients found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit Client Modal -->
<div id="clientModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 id="clientModalTitle" class="text-lg font-semibold mb-4">Add Client</h3>
    <form id="clientForm">
      {% csrf_token %}
      <input type="hidden" id="clientId">
      <input type="text" id="clientName" name="name" class="w-full border p-2 mb-3" placeholder="Client Name" />
      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="clientActive" class="h-4 w-4" />
        <label for="clientActive">Active</label>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeClientModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal"
     class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- JavaScript Handlers -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  function openClientModal() {
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    document.getElementById('clientActive').checked = false;
    document.getElementById('clientModalTitle').innerText = 'Add Client';
    document.getElementById('clientModal').classList.remove('hidden');
  }

  function closeClientModal() {
    document.getElementById('clientModal').classList.add('hidden');
  }

  function openClientEditModal(id) {
    fetch(`/client/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('clientId').value = data.id;
        document.getElementById('clientName').value = data.name;
        document.getElementById('clientActive').checked = data.active;
        document.getElementById('clientModalTitle').innerText = 'Edit Client';
        document.getElementById('clientModal').classList.remove('hidden');
      });
  }

  document.getElementById('clientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('clientId').value;
    const url = id ? `/client/edit/${id}/` : `/client/create/`;
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        name: document.getElementById('clientName').value,
        active: document.getElementById('clientActive').checked ? 'true' : 'false'
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
  closeClientModal();
  location.reload();
} else {
        alert('Save failed');
      }
    });
  });

  let deleteUrl = '';
  function openDeleteModal(url, msg) {
    deleteUrl = url;
    document.getElementById('deleteMessage').innerText = msg;
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = '';
    document.getElementById('deleteModal').classList.add('hidden');
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    fetch(deleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => {
      if (r.ok) {
        closeDeleteModal();
        location.reload();  // Keeps tab using localStorage
      } else {
        alert('Delete failed');
      }
    });
  });

  // Expose to window scope
  window.openClientModal = openClientModal;
  window.closeClientModal = closeClientModal;
  window.openClientEditModal = openClientEditModal;
  window.openDeleteModal = openDeleteModal;
  window.closeDeleteModal = closeDeleteModal;
});
</script>

<!-- Tab Switcher + Restore -->
<script>
  function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById(tabId).classList.remove('hidden');

    // Visual tab button highlight
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('border-blue-600', 'text-blue-600'));
    const activeBtn = document.getElementById('btn-' + tabId);
    if (activeBtn) activeBtn.classList.add('border-blue-600', 'text-blue-600');

    // Save tab
    localStorage.setItem('activeTab', tabId);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const tabFromURL = urlParams.get('active_tab');
    const savedTab = localStorage.getItem('activeTab');

    const tabToShow = tabFromURL || savedTab || 'client-tab';
    switchTab(tabToShow);

    if (tabFromURL) {
      localStorage.setItem('activeTab', tabFromURL);
    }
  });
</script>



<!-- Activity Log Tab -->
<div id="activity-tab" class="tab-content hidden">
  <div class="overflow-x-auto bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">Activity Logs</h2>
    </div>
    <table class="min-w-full table-auto text-sm border border-gray-300">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 text-left">User</th>
          <th class="p-2 text-left">Action</th>
          <th class="p-2 text-left">Target Type</th>
          <th class="p-2 text-left">Target ID</th>
          <th class="p-2 text-left">Timestamp</th>
          <th class="p-2 text-left">Details</th>
        </tr>
      </thead>
      <tbody>
        {% if activity_logs %}
          {% for log in activity_logs %}
            <tr class="border-t">
              <td class="p-2">{{ log.user }}</td>
              <td class="p-2">{{ log.action|title }}</td>
              <td class="p-2">{{ log.target_type }}</td>
              <td class="p-2">{{ log.target_id }}</td>
              <td class="p-2">{{ log.timestamp }}</td>
              <td class="p-2">{{ log.details|default:"-" }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-gray-500 p-4">No activity logs found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>


<!-- Scenario Tab -->
<div id="scenario-tab" class="tab-content hidden">
  <div class="overflow-x-auto bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">Scenario</h2>
      <button onclick="openScenarioModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
        Add Scenario
      </button>
    </div>

    <table class="min-w-full table-fixed text-sm border border-gray-300">
      <thead class="bg-gray-200 text-left">
        <tr>
          <th class="p-2">Scenario ID</th>
          <th class="p-2">Code</th>
          <th class="p-2">Category</th>
          <th class="p-2">Sub Category</th>
          <th class="p-2">Type</th>
          <th class="p-2">Instructions</th>
          <th class="p-2">SOW ID</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in scenario_data %}
        <tr class="border-t">
          <td class="p-2 border-r">{{ row.scenario_id }}</td>
          <td class="p-2 border-r">{{ row.scenario_code }}</td>
          <td class="p-2 border-r">{{ row.scenario_category }}</td>
          <td class="p-2 border-r">{{ row.scenario_sub_category }}</td>
          <td class="p-2 border-r">{{ row.scenario_type }}</td>
          <td class="p-2 border-r">{{ row.scenario_instructions }}</td>
          <td class="p-2 border-r">{{ row.scenario_sow_id }}</td>
          <td class="p-2 flex gap-2">
            <button onclick="openScenarioEditModal({{ row.id }})" class="text-blue-600 text-sm hover:underline">Edit</button>
            <button onclick="openDeleteModal('/scenario/delete/{{ row.id }}/', 'Delete “{{ row.scenario_code }}”?')" class="text-red-600 text-sm hover:underline">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center text-gray-500 p-4">No scenario records found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit Scenario Modal -->
<div id="scenarioModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow max-w-2xl w-full">
    <h3 id="scenarioModalTitle" class="text-lg font-semibold mb-4">Add Scenario</h3>
    <form id="scenarioForm">
      {% csrf_token %}
      <input type="hidden" id="scenarioPrimaryId">
      <div class="grid grid-cols-2 gap-4">
        <input type="number" id="scenarioId" name="scenario_id" class="border p-2" placeholder="Scenario ID" required>
        <input type="text" id="scenarioCode" name="code" class="border p-2" placeholder="Code" required>
        <input type="text" id="scenarioCategory" name="category" class="border p-2" placeholder="Category">
        <input type="text" id="scenarioSubCategory" name="sub_category" class="border p-2" placeholder="Sub Category">
        <input type="text" id="scenarioType" name="type" class="border p-2" placeholder="Type">
        <input type="text" id="scenarioSowId" name="sow_id" class="border p-2" placeholder="SOW ID">
        <textarea id="scenarioInstructions" name="instructions" class="border p-2 col-span-2" placeholder="Instructions"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeScenarioModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- JS Logic -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  function openScenarioModal() {
    document.getElementById('scenarioForm').reset();
    document.getElementById('scenarioPrimaryId').value = '';
    document.getElementById('scenarioModalTitle').innerText = 'Add Scenario';
    document.getElementById('scenarioModal').classList.remove('hidden');
  }

  function closeScenarioModal() {
    document.getElementById('scenarioModal').classList.add('hidden');
  }

  function openScenarioEditModal(id) {
    fetch(`/scenario/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('scenarioPrimaryId').value = data.id;
        document.getElementById('scenarioId').value = data.scenario_id;
        document.getElementById('scenarioCode').value = data.code;
        document.getElementById('scenarioCategory').value = data.category;
        document.getElementById('scenarioSubCategory').value = data.sub_category;
        document.getElementById('scenarioType').value = data.type;
        document.getElementById('scenarioSowId').value = data.sow_id;
        document.getElementById('scenarioInstructions').value = data.instructions;
        document.getElementById('scenarioModalTitle').innerText = 'Edit Scenario';
        document.getElementById('scenarioModal').classList.remove('hidden');
      });
  }

  document.getElementById('scenarioForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('scenarioPrimaryId').value;
    const url = id ? `/scenario/edit/${id}/` : `/scenario/create/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        scenario_id: document.getElementById('scenarioId').value,
        code: document.getElementById('scenarioCode').value,
        category: document.getElementById('scenarioCategory').value,
        sub_category: document.getElementById('scenarioSubCategory').value,
        type: document.getElementById('scenarioType').value,
        instructions: document.getElementById('scenarioInstructions').value,
        sow_id: document.getElementById('scenarioSowId').value
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        closeScenarioModal();
        location.reload();
      } else {
        alert('Save failed');
      }
    });
  });

  let deleteUrl = '';
  function openDeleteModal(url, msg) {
    deleteUrl = url;
    document.getElementById('deleteMessage').innerText = msg;
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = '';
    document.getElementById('deleteModal').classList.add('hidden');
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    fetch(deleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => {
      if (r.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });

  // Expose globally
  window.openScenarioModal = openScenarioModal;
  window.closeScenarioModal = closeScenarioModal;
  window.openScenarioEditModal = openScenarioEditModal;
  window.openDeleteModal = openDeleteModal;
  window.closeDeleteModal = closeDeleteModal;
});
</script>

<!-- DxCategory Tab -->
<div id="dxcategory-tab" class="tab-content hidden">
  <div class="overflow-x-auto bg-white p-4 rounded shadow">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">DxCategory</h2>
      <button onclick="openDxCategoryModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
        Add DxCategory
      </button>
    </div>

    <table class="min-w-full table-fixed text-sm border border-gray-300">
      <thead class="bg-gray-200 text-left">
        <tr>
          <th class="p-2">Category ID</th>
          <th class="p-2">Code</th>
          <th class="p-2">Category</th>
          <th class="p-2">Sub Category</th>
          <th class="p-2">Type</th>
          <th class="p-2">Instructions</th>
          <th class="p-2">SOW ID</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in dxcategory_data %}
        <tr class="border-t">
          <td class="p-2 border-r">{{ row.dxcategory_id }}</td>
          <td class="p-2 border-r">{{ row.dxcategory_code }}</td>
          <td class="p-2 border-r">{{ row.dxcategory_category }}</td>
          <td class="p-2 border-r">{{ row.dxcategory_sub_category }}</td>
          <td class="p-2 border-r">{{ row.dxcategory_type }}</td>
          <td class="p-2 border-r">{{ row.dxcategory_instructions }}</td>
          <td class="p-2 border-r">{{ row.dxcategory_sow_id }}</td>
          <td class="p-2 flex gap-2">
            <button onclick="openDxCategoryEditModal({{ row.id }})" class="text-blue-600 text-sm hover:underline">Edit</button>
            <button onclick="openDeleteModal('/dxcategory/delete/{{ row.id }}/', 'Delete “{{ row.dxcategory_code }}”?')" class="text-red-600 text-sm hover:underline">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center text-gray-500 p-4">No dxcategory records found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit DxCategory Modal -->
<div id="dxCategoryModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow max-w-2xl w-full">
    <h3 id="dxCategoryModalTitle" class="text-lg font-semibold mb-4">Add DxCategory</h3>
    <form id="dxCategoryForm">
      {% csrf_token %}
      <input type="hidden" id="primaryId">
      <div class="grid grid-cols-2 gap-4">
        <input type="number" id="dxcategoryId" name="dxcategory_id" class="border p-2" placeholder="Category ID" required>
        <input type="text" id="dxcategoryCode" name="code" class="border p-2" placeholder="Code" required>
        <input type="text" id="dxcategoryCategory" name="category" class="border p-2" placeholder="Category">
        <input type="text" id="dxcategorySubCategory" name="sub_category" class="border p-2" placeholder="Sub Category">
        <input type="text" id="dxcategoryType" name="type" class="border p-2" placeholder="Type">
        <input type="text" id="dxcategorySowId" name="sow_id" class="border p-2" placeholder="SOW ID">
        <textarea id="dxcategoryInstructions" name="instructions" class="border p-2 col-span-2" placeholder="Instructions"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeDxCategoryModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>

<!-- JS Logic -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  function openDxCategoryModal() {
    document.getElementById('dxCategoryForm').reset();
    document.getElementById('primaryId').value = '';
    document.getElementById('dxCategoryModalTitle').innerText = 'Add DxCategory';
    document.getElementById('dxCategoryModal').classList.remove('hidden');
  }

  function closeDxCategoryModal() {
    document.getElementById('dxCategoryModal').classList.add('hidden');
  }

  function openDxCategoryEditModal(id) {
    fetch(`/dxcategory/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('primaryId').value = data.id;
        document.getElementById('dxcategoryId').value = data.dxcategory_id;
        document.getElementById('dxcategoryCode').value = data.code;
        document.getElementById('dxcategoryCategory').value = data.category;
        document.getElementById('dxcategorySubCategory').value = data.sub_category;
        document.getElementById('dxcategoryType').value = data.type;
        document.getElementById('dxcategorySowId').value = data.sow_id;
        document.getElementById('dxcategoryInstructions').value = data.instructions;
        document.getElementById('dxCategoryModalTitle').innerText = 'Edit DxCategory';
        document.getElementById('dxCategoryModal').classList.remove('hidden');
      });
  }

  document.getElementById('dxCategoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const id = document.getElementById('primaryId').value;
    const url = id ? `/dxcategory/edit/${id}/` : `/dxcategory/create/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: new URLSearchParams({
        dxcategory_id: document.getElementById('dxcategoryId').value,
        code: document.getElementById('dxcategoryCode').value,
        category: document.getElementById('dxcategoryCategory').value,
        sub_category: document.getElementById('dxcategorySubCategory').value,
        type: document.getElementById('dxcategoryType').value,
        instructions: document.getElementById('dxcategoryInstructions').value,
        sow_id: document.getElementById('dxcategorySowId').value
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        closeDxCategoryModal();
        location.reload();
      } else {
        alert('Save failed');
      }
    });
  });

  let deleteUrl = '';
  function openDeleteModal(url, msg) {
    deleteUrl = url;
    document.getElementById('deleteMessage').innerText = msg;
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = '';
    document.getElementById('deleteModal').classList.add('hidden');
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    fetch(deleteUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(r => {
      if (r.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });

  // Expose functions globally
  window.openDxCategoryModal = openDxCategoryModal;
  window.closeDxCategoryModal = closeDxCategoryModal;
  window.openDxCategoryEditModal = openDxCategoryEditModal;
  window.openDeleteModal = openDeleteModal;
  window.closeDeleteModal = closeDeleteModal;
});
</script>


<!-- User Tab -->
<div id="user-tab" class="tab-content hidden">
  <div class="overflow-x-auto bg-white p-4 rounded shadow mb-6">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">User Accounts</h2>
      <button onclick="openUserModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
        Add User
      </button>
    </div>
  <table class="min-w-full table-fixed text-sm border border-gray-300">
    <thead class="bg-gray-200 text-left">
      <tr>
        <th class="p-2 border-r">Name</th>
        <th class="p-2 border-r">Email</th>
        <th class="p-2 border-r">Role</th>
        <th class="p-2 border-r">Client</th>
        <th class="p-2 border-r">Status</th>
        <th class="p-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% regroup users by role as role_groups %}
      {% if role_groups %}
        {% for group in role_groups %}
          <!-- Group header row -->
          <tr class="bg-blue-50 border-t">
            <td colspan="6" class="p-2 font-semibold flex justify-between items-center">
              <span>👤 Role: {{ group.grouper|title }}</span>
              <button
                id="btn-{{ group.grouper|slugify }}"
                type="button"
                onclick="toggleRoleGroup('{{ group.grouper|slugify }}')"
                class="text-blue-600 text-sm hover:underline">
                See More
              </button>
            </td>
          </tr>

          <!-- Detail rows, hidden by default -->
          {% for user in group.list %}
            <tr class="border-t hidden" data-role="{{ group.grouper|slugify }}">
              <td class="p-2 border-r">{{ user.name }}</td>
              <td class="p-2 border-r">{{ user.email }}</td>
              <td class="p-2 border-r">{{ user.get_role_display }}</td>
              <td class="p-2 border-r">
                {% if user.client %}
                  {{ user.client.name }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="p-2 border-r">
                {% if user.is_active %}
                  <span class="text-green-600 font-medium">Active</span>
                {% else %}
                  <span class="text-red-500 font-medium">Inactive</span>
                {% endif %}
              </td>
              <td class="p-2 border-l flex gap-3">
                <button onclick="openUserEditModal({{ user.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button
                  onclick="openDeleteModal('{% url 'user_delete' user.id %}', 'Delete {{ user.email }}?')"
                  class="text-red-600 hover:underline text-sm">
                  Delete
                </button>
              </td>
            </tr>
          {% endfor %}
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="6" class="text-center text-gray-500 p-4">No users found.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 id="userModalTitle" class="text-lg font-semibold mb-4">Add User</h3>
    <form id="userForm">
      {% csrf_token %}
      <input type="hidden" id="userId">
      <input type="text" id="userName" name="name" class="w-full border p-2 mb-3" placeholder="Full Name" required />
      <input type="email" id="userEmail" name="email" class="w-full border p-2 mb-3" placeholder="Email" required />

      <select id="userRole" name="role" class="w-full border p-2 mb-3">
        <option value="">Select Role</option>
        <option value="admin">Admin</option>
        <option value="manager">Manager</option>
        <option value="viewer">Viewer</option>
      </select>

      <select id="userClient" name="client" class="w-full border p-2 mb-3">
        <option value="">Select Client (Optional)</option>
        {% for client in clients %}
          <option value="{{ client.id }}">{{ client.name }}</option>
        {% endfor %}
      </select>

      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="userActive" class="h-4 w-4" />
        <label for="userActive">Active</label>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeUserModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="userDeleteModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <button onclick="closeUserDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="userDeleteMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeUserDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmUserDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
  // Open empty form
  function openUserModal() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userActive').checked = true;
    document.getElementById('userModalTitle').innerText = 'Add User';
    document.getElementById('userModal').classList.remove('hidden');
  }

  function closeUserModal() {
    document.getElementById('userModal').classList.add('hidden');
  }

  // Edit User
  function openUserEditModal(id) {
    fetch(`/user/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('userId').value = data.id;
        document.getElementById('userName').value = data.name;
        document.getElementById('userEmail').value = data.email;
        document.getElementById('userRole').value = data.role;
        document.getElementById('userClient').value = data.client_id || '';
        document.getElementById('userActive').checked = data.is_active;
        document.getElementById('userModalTitle').innerText = 'Edit User';
        document.getElementById('userModal').classList.remove('hidden');
      });
  }

  document.getElementById('userForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const id = document.getElementById('userId').value;
    const url = id ? `/user/edit/${id}/` : `/user/create/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: new URLSearchParams({
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        role: document.getElementById('userRole').value,
        client: document.getElementById('userClient').value,
        active: document.getElementById('userActive').checked ? 'true' : 'false'
      })
    }).then(r => r.json())
      .then(data => {
        if (data.success) {
          closeUserModal();
          location.reload();
        } else {
          alert("Save failed");
        }
      });
  });

  let userDeleteUrl = '';
  function openUserDeleteModal(url, msg) {
    userDeleteUrl = url;
    document.getElementById('userDeleteMessage').innerText = msg;
    document.getElementById('userDeleteModal').classList.remove('hidden');
  }

  function closeUserDeleteModal() {
    userDeleteUrl = '';
    document.getElementById('userDeleteModal').classList.add('hidden');
  }

  document.getElementById('confirmUserDeleteBtn').addEventListener('click', function () {
    fetch(userDeleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    }).then(r => {
      if (r.ok) {
        closeUserDeleteModal();
        location.reload();
      } else {
        alert("Delete failed");
      }
    });
  });

  // Expose functions
  window.openUserModal = openUserModal;
  window.closeUserModal = closeUserModal;
  window.openUserEditModal = openUserEditModal;
  window.openUserDeleteModal = openUserDeleteModal;
  window.closeUserDeleteModal = closeUserDeleteModal;
});
</script>


</body>
</html>

