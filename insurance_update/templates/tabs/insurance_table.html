<!-- Insurance Tab -->
  <div id="insurance-tab" class="tab-content">
    <form method="get" class="mb-4">
  <div class="flex flex-wrap gap-4 text-sm items-center">
    <select name="payer_name" class="p-2 border rounded">
      <option value="">Payer Name</option>
      {% for name in payer_names %}
        <option value="{{ name }}" {% if request.GET.payer_name == name %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <select name="payer_category" class="p-2 border rounded">
      <option value="">Payer Category</option>
      {% for cat in payer_categories %}
        <option value="{{ cat }}" {% if request.GET.payer_category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>

    <select name="edit_type" class="p-2 border rounded">
      <option value="">Edit Category</option>
      {% for et in edit_types %}
        <option value="{{ et }}" {% if et == filters.edit_type %}selected{% endif %}>{{ et }}</option>
      {% endfor %}
    </select>

    <select name="edit_sub_category" class="p-2 border rounded">
      <option value="">Sub Category</option>
      {% for sub in edit_sub_categories %}
        <option value="{{ sub }}" {% if request.GET.edit_sub_category == sub %}selected{% endif %}>{{ sub }}</option>
      {% endfor %}
    </select>

    <input type="hidden" name="active_tab" id="active_tab_input" value="">

    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Filter</button>
    <a href="{% url 'model_tables' %}#insurance-tab" class="px-4 py-2 bg-gray-400 text-white rounded">Clear</a>
  </div>
</form>

    <div class="overflow-x-auto bg-white p-4 rounded shadow">
  <!-- Header with Add button -->
  <h2 class="text-lg font-semibold mb-3 flex justify-between items-center">
    <span>Insurance Edit Records</span>
    <div class="flex gap-2 items-center">

  <!-- Upload Excel Form -->
  <form method="post" action="{% url 'insurance_preview_upload' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <label class="cursor-pointer bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">
      Upload Excel
      <input type="file" name="excel_file" accept=".xlsx,.xls" onchange="this.form.submit()" hidden>
    </label>
  </form>

  <!-- Add Insurance Button -->
  <button onclick="openInsuranceModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
    Add Insurance
  </button>

        <a href="{% url 'insurance_download_excel' %}" >
        <button id="" type="button" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm">Download
        </button>
        </a>

</div>


  </h2>
<div class="overflow-y-auto max-h-[600px] border border-gray-300">
<!--  <table class="min-w-full table-fixed text-sm">-->
    <table class="min-w-full table-fixed text-sm">
    <thead class="bg-gray-200 text-left sticky top-0 z-10">
      <tr>
        <th class="p-2 border-r bg-gray-200">Client</th>
        <th class="p-2 border-r bg-gray-200">Payer Name</th>
        <th class="p-2 border-r bg-gray-200">Payer Category</th>
        <th class="p-2 border-r bg-gray-200">Edits Category</th>
        <th class="p-2 border-r bg-gray-200">Edits Sub-Category</th>
        <th class="p-2 whitespace-wrap bg-gray-200">Instruction</th>
        <th class="p-2 bg-gray-200">Actions</th>
      </tr>
    </thead>
    <tbody>
  {% if grouped_insurance_edits %}
    {% for group, edits in grouped_insurance_edits %}
      {% with payer_name=group.0 payer_category=group.1 %}
        {% with key=payer_name|slugify|add:"__"|add:payer_category|slugify %}
          <!-- Group Header Row -->
          <tr class=" border-t text-sm">
            <td class="p-1 w-[200px] font-semibold truncate">
              {{ payer_name }} — {{ payer_category }}
            </td>
            <td class="p-1 w-[200px]">
              <button
                id="btn-{{ key }}"
                type="button"
                onclick="togglePayer('{{ key }}')"
                class="text-blue-600 text-xs px-2 py-0.5 border border-blue-300 rounded hover:bg-blue-100">
                See More
              </button>
            </td>
            <td colspan="4" class="p-1"></td>
          </tr>

          {% for edit in edits %}
            <tr class="border-t hidden" data-payer="{{ key }}">
              <td class="p-2 border-r">{{ edit.client }}</td>
              <td class="p-2 border-r">{{ edit.payer_name }}</td>
              <td class="p-2 border-r">{{ edit.payer_category }}</td>
              <td class="p-2 border-r">{{ edit.edit_type }}</td>
              <td class="p-2 border-r">{{ edit.edit_sub_category }}</td>
              <td class="p-2 w-[400px] whitespace-pre-wrap break-words">{{ edit.instruction }}</td>
              <td class="p-2 border-l flex gap-2">
                <button onclick="openEditModal({{ edit.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button
                  onclick="openDeleteModal('{% url 'insurance_delete' edit.id %}', 'Delete “{{ edit.payer_name }}”?')"
                  class="text-red-600 hover:underline text-sm">
                  Delete
                </button>
              </td>
            </tr>
          {% endfor %}
        {% endwith %}
      {% endwith %}
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="6" class="text-center text-gray-500 py-6">No records found.</td>
    </tr>
  {% endif %}
</tbody>

  </table>
</div>

</div>


<!-- Toggle script -->
<script>
  function togglePayer(slug) {
    const rows = document.querySelectorAll(`[data-payer="${slug}"]`);
    const btn = document.getElementById(`btn-${slug}`);
    if (!rows.length || !btn) return;

    const isCurrentlyHidden = rows[0].classList.contains('hidden');
    rows.forEach(r => r.classList.toggle('hidden'));
    btn.textContent = isCurrentlyHidden ? 'Hide' : 'See More';
  }
</script>

  </div>

  <!-- Insurance Edit Modal -->
<div id="insuranceModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
    <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Insurance</h2>
    <form id="insuranceForm">
      {% csrf_token %}
      <input type="hidden" id="insuranceId" name="id">

      <div class="grid grid-cols-2 gap-4">
        <!-- Client Dropdown -->
        <div class="col-span-2">
          <label class="block text-sm font-medium">Select Client</label>
          <select id="client" name="client" class="mt-1 p-2 border rounded w-full">
            <option value="">-- Select Client --</option>
            {% for client in clients %}
              <option value="{{ client.id }}">{{ client.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium">Payer Name</label>
          <input type="text" id="payerName" name="payer_name" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Payer Category</label>
          <input type="text" id="payerCategory" name="payer_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Edit Type</label>
          <input type="text" id="editType" name="edit_type" class="mt-1 p-2 border rounded w-full">
        </div>
        <div>
          <label class="block text-sm font-medium">Edit Sub-Category</label>
          <input type="text" id="editSubCategory" name="edit_sub_category" class="mt-1 p-2 border rounded w-full">
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium">Instruction</label>
          <textarea id="instruction" name="instruction" class="mt-1 p-2 border rounded w-full"></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button" onclick="closeInsuranceModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
</div>

  <!-- Delete Confirmation Modal -->
<div id="deleteInsuranceModal"
     class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <!-- Close Icon -->
    <button onclick="closeDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">✕</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="deleteInsuranceMessage" class="mb-6">Are you sure you want to delete this record?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
      <button id="confirmDeleteInsuranceBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>

  <script>
function openInsuranceModal() {
  document.getElementById('insuranceForm').reset();
  document.getElementById('insuranceId').value = '';
  document.getElementById('modalTitle').innerText = 'Add Insurance';
  document.getElementById('insuranceModal').classList.remove('hidden');
}

function openEditModal(id) {
  fetch(`/insurance/edit/${id}/`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('insuranceId').value = data.id;
      document.getElementById('client').value = data.client;
      document.getElementById('payerName').value = data.payer_name;
      document.getElementById('payerCategory').value = data.payer_category;
      document.getElementById('editType').value = data.edit_type;
      document.getElementById('editSubCategory').value = data.edit_sub_category;
      document.getElementById('instruction').value = data.instruction;
      document.getElementById('modalTitle').innerText = 'Edit Insurance';
      document.getElementById('insuranceModal').classList.remove('hidden');
    });
}

function closeInsuranceModal() {
  document.getElementById('insuranceModal').classList.add('hidden');
}

// Handle form submit
document.getElementById('insuranceForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = document.getElementById('insuranceId').value;
  const url = id ? `/insurance/edit/${id}/` : `/insurance/create/`;
  const method = 'POST';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: new URLSearchParams({
      client: document.getElementById('client').value,
      payer_name: document.getElementById('payerName').value,
      payer_category: document.getElementById('payerCategory').value,
      edit_type: document.getElementById('editType').value,
      edit_sub_category: document.getElementById('editSubCategory').value,
      instruction: document.getElementById('instruction').value
    })
  }).then(res => {
    if (res.ok) {
      location.reload();
    }
  });
});

  let deleteUrl = null;

  function openDeleteModal(url, message) {
    deleteUrl = url;
    document.getElementById('deleteInsuranceMessage').innerText = message || 'Are you sure you want to delete this record?';
    document.getElementById('deleteInsuranceModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    deleteUrl = null;
    document.getElementById('deleteInsuranceModal').classList.add('hidden');
  }

  document.getElementById('confirmDeleteInsuranceBtn').addEventListener('click', function() {
    if (!deleteUrl) return;
    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      }
    })
    .then(res => {
      if (res.ok) {
        closeDeleteModal();
        location.reload();
      } else {
        alert('Delete failed');
      }
    });
  });
</script>


