<!-- User Tab -->
<div id="user-tab" class="tab-content hidden">
  <div class="overflow-x-auto bg-white p-4 rounded shadow mb-6">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">User Accounts</h2>
      <button onclick="openUserModal()" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 text-sm">
        Add User
      </button>
    </div>
  <table class="min-w-full table-fixed text-sm border border-gray-300">
    <thead class="bg-gray-200 text-left">
      <tr>
        <th class="p-2 border-r">Name</th>
        <th class="p-2 border-r">Email</th>
        <th class="p-2 border-r">Role</th>
        <th class="p-2 border-r">Client</th>
        <th class="p-2 border-r">Status</th>
        <th class="p-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% regroup users by role as role_groups %}
      {% if role_groups %}
        {% for group in role_groups %}
          <!-- Group header row -->
          <tr class="bg-blue-50 border-t">
            <td colspan="6" class="p-2 font-semibold flex justify-between items-center">
              <span>ðŸ‘¤ Role: {{ group.grouper|title }}</span>
              <button
                id="btn-{{ group.grouper|slugify }}"
                type="button"
                onclick="toggleRoleGroup('{{ group.grouper|slugify }}')"
                class="text-blue-600 text-sm hover:underline">
                See More
              </button>
            </td>
          </tr>

          <!-- Detail rows, hidden by default -->
          {% for user in group.list %}
            <tr class="border-t hidden" data-role="{{ group.grouper|slugify }}">
              <td class="p-2 border-r">{{ user.name }}</td>
              <td class="p-2 border-r">{{ user.email }}</td>
              <td class="p-2 border-r">{{ user.get_role_display }}</td>
              <td class="p-2 border-r">
                {% if user.client %}
                  {{ user.client.name }}
                {% else %}
                  â€”
                {% endif %}
              </td>
              <td class="p-2 border-r">
                {% if user.is_active %}
                  <span class="text-green-600 font-medium">Active</span>
                {% else %}
                  <span class="text-red-500 font-medium">Inactive</span>
                {% endif %}
              </td>
              <td class="p-2 border-l flex gap-3">
                <button onclick="openUserEditModal({{ user.id }})" class="text-blue-600 hover:underline text-sm">Edit</button>
                <button
                  onclick="openDeleteModal('{% url 'user_delete' user.id %}', 'Delete {{ user.email }}?')"
                  class="text-red-600 hover:underline text-sm">
                  Delete
                </button>
              </td>
            </tr>
          {% endfor %}
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="6" class="text-center text-gray-500 p-4">No users found.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
</div>

<!-- Create/Edit User Modal -->
<div id="userModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow max-w-md w-full">
    <h3 id="userModalTitle" class="text-lg font-semibold mb-4">Add User</h3>
    <form id="userForm">
      {% csrf_token %}
      <input type="hidden" id="userId">
      <input type="text" id="userName" name="name" class="w-full border p-2 mb-3" placeholder="Full Name" required />
      <input type="email" id="userEmail" name="email" class="w-full border p-2 mb-3" placeholder="Email" required />

      <select id="userRole" name="role" class="w-full border p-2 mb-3">
        <option value="">Select Role</option>
        <option value="admin">Admin</option>
        <option value="manager">Manager</option>
        <option value="viewer">Viewer</option>
      </select>

      <select id="userClient" name="client" class="w-full border p-2 mb-3">
        <option value="">Select Client (Optional)</option>
        {% for client in clients %}
          <option value="{{ client.id }}">{{ client.name }}</option>
        {% endfor %}
      </select>

      <div class="flex items-center gap-2 mb-4">
        <input type="checkbox" id="userActive" class="h-4 w-4" />
        <label for="userActive">Active</label>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeUserModal()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="userDeleteModal" class="fixed inset-0 flex bg-gray-900 bg-opacity-50 hidden items-start justify-center pt-20 z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <button onclick="closeUserDeleteModal()" class="absolute top-2 right-2 text-gray-600 hover:text-black">âœ•</button>
    <h3 class="text-xl font-semibold mb-4 text-red-600">Confirm Delete</h3>
    <p id="userDeleteMessage" class="mb-6">Are you sure?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeUserDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded">Cancel</button>
      <button id="confirmUserDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
  // Open empty form
  function openUserModal() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userActive').checked = true;
    document.getElementById('userModalTitle').innerText = 'Add User';
    document.getElementById('userModal').classList.remove('hidden');
  }

  function closeUserModal() {
    document.getElementById('userModal').classList.add('hidden');
  }

  // Edit User
  function openUserEditModal(id) {
    fetch(`/user/edit/${id}/`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('userId').value = data.id;
        document.getElementById('userName').value = data.name;
        document.getElementById('userEmail').value = data.email;
        document.getElementById('userRole').value = data.role;
        document.getElementById('userClient').value = data.client_id || '';
        document.getElementById('userActive').checked = data.is_active;
        document.getElementById('userModalTitle').innerText = 'Edit User';
        document.getElementById('userModal').classList.remove('hidden');
      });
  }

  document.getElementById('userForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const id = document.getElementById('userId').value;
    const url = id ? `/user/edit/${id}/` : `/user/create/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: new URLSearchParams({
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        role: document.getElementById('userRole').value,
        client: document.getElementById('userClient').value,
        active: document.getElementById('userActive').checked ? 'true' : 'false'
      })
    }).then(r => r.json())
      .then(data => {
        if (data.success) {
          closeUserModal();
          location.reload();
        } else {
          alert("Save failed");
        }
      });
  });

  let userDeleteUrl = '';
  function openUserDeleteModal(url, msg) {
    userDeleteUrl = url;
    document.getElementById('userDeleteMessage').innerText = msg;
    document.getElementById('userDeleteModal').classList.remove('hidden');
  }

  function closeUserDeleteModal() {
    userDeleteUrl = '';
    document.getElementById('userDeleteModal').classList.add('hidden');
  }

  document.getElementById('confirmUserDeleteBtn').addEventListener('click', function () {
    fetch(userDeleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    }).then(r => {
      if (r.ok) {
        closeUserDeleteModal();
        location.reload();
      } else {
        alert("Delete failed");
      }
    });
  });

  // Expose functions
  window.openUserModal = openUserModal;
  window.closeUserModal = closeUserModal;
  window.openUserEditModal = openUserEditModal;
  window.openUserDeleteModal = openUserDeleteModal;
  window.closeUserDeleteModal = closeUserDeleteModal;
});
</script>
